name: Ubuntu

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [clang, gcc]
        include:
          - compiler: clang
            cc: clang
            cxx: clang++
            coverage: 'true'
          - compiler: gcc
            cc: gcc-14
            cxx: g++-14
            coverage: 'false'

    name: build (${{ matrix.compiler }})

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-${{ matrix.compiler }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends coinor-libcbc-dev libboost-container-dev libspdlog-dev lcov ca-certificates lsb-release wget
          wget https://packages.apache.org/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get install -y --no-install-recommends -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends -V libarrow-dev libparquet-dev

      - name: install clang
        uses: ./.github/actions/install-clang
        with:
          version: 21
          install-coverage-runtime: ${{ matrix.coverage }}

      - name: setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ github.workflow }}-${{ matrix.compiler }}-build
          max-size: 2G

      - name: configure
        run: cmake -Stest -Bbuild -DENABLE_TEST_COVERAGE=${{ matrix.coverage == 'true' && '1' || '0' }} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: build
        run: cmake --build build -j$(nproc)

      - name: test
        run: |
          set -o pipefail
          cd build
          ctest --build-config Debug --output-on-failure 2>&1 | tee ctest_output.log
          echo ""
          echo "=== Test Summary ==="
          TOTAL=$(grep -c "Test #" ctest_output.log || echo 0)
          PASSED=$(grep -c "Passed" ctest_output.log || echo 0)
          FAILED=$(grep -c "Failed" ctest_output.log || echo 0)
          echo "Total: $TOTAL | Passed: $PASSED | Failed: $FAILED"

      - name: collect code coverage
        if: matrix.coverage == 'true'
        run: |
          # Create llvm-cov gcov wrapper for lcov compatibility
          printf '#!/bin/sh\nexec llvm-cov gcov "$@"\n' > /tmp/llvm-gcov.sh
          chmod +x /tmp/llvm-gcov.sh
          # Capture coverage data with lcov
          # --ignore-errors mismatch,mismatch: fully suppress mismatch warnings
          #   from third-party headers (daw_json, boost, libstdc++)
          # --ignore-errors unexecuted,unexecuted: fully suppress unexecuted block
          #   warnings from system/third-party headers (allocator, flat_map, etc.)
          # --ignore-errors negative,negative: suppress negative branch count
          #   errors from system headers (unique_ptr, etc.)
          # --rc geninfo_unexecuted_blocks=1: tell geninfo to zero out counts on
          #   unexecuted non-branch lines (eliminates "unexecuted block" warnings)
          # --rc branch_coverage=1: enable branch coverage tracking
          lcov --capture --directory build --output-file coverage-raw.info \
            --gcov-tool /tmp/llvm-gcov.sh \
            --ignore-errors mismatch,mismatch \
            --ignore-errors unexecuted,unexecuted \
            --ignore-errors negative,negative \
            --ignore-errors inconsistent,inconsistent \
            --rc geninfo_unexecuted_blocks=1 \
            --rc branch_coverage=1
          # Remove external/test/system files from coverage
          lcov --remove coverage-raw.info \
            '/usr/*' \
            '*/cpm_modules/*' \
            '*/test/*' \
            '*/daw/*' \
            '*/strong_type/*' \
            '*/spdlog/*' \
            --output-file coverage.info \
            --gcov-tool /tmp/llvm-gcov.sh --ignore-errors unused,inconsistent \
            --rc branch_coverage=1
          # Print summary to the job log
          lcov --list coverage.info --gcov-tool /tmp/llvm-gcov.sh --rc branch_coverage=1 \
            --ignore-errors inconsistent
          # Generate HTML report
          genhtml coverage.info --output-directory coverage-report \
            --title "gtopt C++ Test Coverage" \
            --legend --show-details \
            --rc branch_coverage=1 \
            --ignore-errors inconsistent

      - name: upload coverage report
        if: always() && matrix.coverage == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cpp-coverage-report-${{ matrix.compiler }}
          path: coverage-report/
          retention-days: 30

      - name: generate coverage summary
        if: always() && matrix.coverage == 'true'
        run: |
          if [ ! -f coverage.info ]; then
            echo "## C++ Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Coverage data not available (test or coverage collection step failed)." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          # Extract coverage percentages for the job summary
          SUMMARY=$(lcov --summary coverage.info --gcov-tool /tmp/llvm-gcov.sh --rc branch_coverage=1 \
            --ignore-errors inconsistent,inconsistent 2>&1) || true
          LINE_PCT=$(echo "$SUMMARY" | grep 'lines' | head -1 | grep -oP '[\d.]+%' | head -1)
          LINE_DETAIL=$(echo "$SUMMARY" | grep 'lines' | head -1 | grep -oP '\(.*\)')
          FUNC_PCT=$(echo "$SUMMARY" | grep 'functions' | head -1 | grep -oP '[\d.]+%' | head -1)
          FUNC_DETAIL=$(echo "$SUMMARY" | grep 'functions' | head -1 | grep -oP '\(.*\)')
          BRANCH_PCT=$(echo "$SUMMARY" | grep 'branches' | head -1 | grep -oP '[\d.]+%' | head -1)
          BRANCH_DETAIL=$(echo "$SUMMARY" | grep 'branches' | head -1 | grep -oP '\(.*\)')
          echo "## C++ Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINE_PCT} | ${LINE_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${FUNC_PCT} | ${FUNC_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${BRANCH_PCT} | ${BRANCH_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # List files with 0% line coverage (coverage gaps)
          ZERO_FILES=$(lcov --list coverage.info --gcov-tool /tmp/llvm-gcov.sh --rc branch_coverage=1 2>&1 | grep '|.*0\.0%' | head -10 || true)
          if [ -n "$ZERO_FILES" ]; then
            echo "<details><summary>‚ö†Ô∏è Files with 0% line coverage</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$ZERO_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "üì• Download the full HTML coverage report from the **cpp-coverage-report** artifact." >> $GITHUB_STEP_SUMMARY

  integration:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [clang, gcc]
        include:
          - compiler: clang
            cc: clang
            cxx: clang++
            coverage: 'true'
          - compiler: gcc
            cc: gcc-14
            cxx: g++-14
            coverage: 'false'

    name: integration (${{ matrix.compiler }})

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-${{ matrix.compiler }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends coinor-libcbc-dev libboost-container-dev libspdlog-dev lcov ca-certificates lsb-release wget
          wget https://packages.apache.org/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get install -y --no-install-recommends -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends -V libarrow-dev libparquet-dev

      - name: install clang
        uses: ./.github/actions/install-clang
        with:
          version: 21
          install-coverage-runtime: ${{ matrix.coverage }}

      - name: setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ github.workflow }}-${{ matrix.compiler }}-integration
          max-size: 2G

      - name: configure standalone (Release, for install)
        run: cmake -Sstandalone -Bbuild -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: build standalone
        run: cmake --build build -j$(nproc)

      - name: install gtopt
        run: cmake --install build --prefix build/install

      - name: verify installed binary has no missing shared libraries
        run: |
          echo "=== ldd output ==="
          ldd build/install/bin/gtopt
          if ldd build/install/bin/gtopt | grep -q "not found"; then
            echo "::error::Installed gtopt binary has missing shared libraries"
            exit 1
          fi
          echo "‚úì All shared libraries resolved"

      - name: verify installed binary runs
        run: |
          build/install/bin/gtopt --version
          echo "‚úì Installed gtopt --version works"

      - name: configure integration_test (Debug, with coverage)
        run: cmake -Sintegration_test -Bbuild-integration -DENABLE_TEST_COVERAGE=${{ matrix.coverage == 'true' && '1' || '0' }} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: build integration_test
        run: cmake --build build-integration -j$(nproc)

      - name: run integration tests
        run: |
          cd build-integration
          ctest --build-config Debug --output-on-failure

      - name: collect integration test coverage
        if: matrix.coverage == 'true'
        run: |
          # Create llvm-cov gcov wrapper for lcov compatibility
          printf '#!/bin/sh\nexec llvm-cov gcov "$@"\n' > /tmp/llvm-gcov.sh
          chmod +x /tmp/llvm-gcov.sh
          lcov --capture --directory build-integration --output-file integration-coverage-raw.info \
            --gcov-tool /tmp/llvm-gcov.sh \
            --ignore-errors mismatch,mismatch \
            --ignore-errors unexecuted,unexecuted \
            --ignore-errors negative,negative \
            --ignore-errors inconsistent,inconsistent \
            --rc geninfo_unexecuted_blocks=1 \
            --rc branch_coverage=1
          lcov --remove integration-coverage-raw.info \
            '/usr/*' \
            '*/cpm_modules/*' \
            '*/test/*' \
            '*/daw/*' \
            '*/strong_type/*' \
            '*/spdlog/*' \
            --output-file integration-coverage.info \
            --gcov-tool /tmp/llvm-gcov.sh --ignore-errors unused,inconsistent \
            --rc branch_coverage=1
          lcov --list integration-coverage.info --gcov-tool /tmp/llvm-gcov.sh --rc branch_coverage=1 \
            --ignore-errors inconsistent
          genhtml integration-coverage.info --output-directory integration-coverage-report \
            --title "gtopt Integration Test Coverage" \
            --legend --show-details \
            --rc branch_coverage=1 \
            --ignore-errors inconsistent

      - name: upload integration coverage report
        if: always() && matrix.coverage == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage-report-${{ matrix.compiler }}
          path: integration-coverage-report/
          retention-days: 30

      - name: generate integration coverage summary
        if: always() && matrix.coverage == 'true'
        run: |
          if [ ! -f integration-coverage.info ]; then
            echo "## Integration Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Coverage data not available." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          SUMMARY=$(lcov --summary integration-coverage.info --gcov-tool /tmp/llvm-gcov.sh --rc branch_coverage=1 \
            --ignore-errors inconsistent,inconsistent 2>&1) || true
          LINE_PCT=$(echo "$SUMMARY" | grep 'lines' | head -1 | grep -oP '[\d.]+%' | head -1)
          LINE_DETAIL=$(echo "$SUMMARY" | grep 'lines' | head -1 | grep -oP '\(.*\)')
          FUNC_PCT=$(echo "$SUMMARY" | grep 'functions' | head -1 | grep -oP '[\d.]+%' | head -1)
          FUNC_DETAIL=$(echo "$SUMMARY" | grep 'functions' | head -1 | grep -oP '\(.*\)')
          echo "## Integration Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINE_PCT} | ${LINE_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${FUNC_PCT} | ${FUNC_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "üì• Download the full HTML coverage report from the **integration-coverage-report** artifact." >> $GITHUB_STEP_SUMMARY
