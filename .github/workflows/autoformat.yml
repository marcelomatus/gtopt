name: Auto-format

# Runs clang-format on every push and auto-commits any fixes back to the
# branch.  This catches code generated by Copilot agents, automated actions,
# and any local commit that bypassed the pre-commit hook.

on:
  push:
    branches-ignore:
      - master
      - main

# Need write access to push the fixup commit
permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  autoformat:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          # Check out the branch that was pushed (not a detached HEAD)
          ref: ${{ github.head_ref || github.ref_name }}
          # Use a token that is allowed to push to the branch
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install clang
        uses: egor-tensin/setup-clang@v2
        with:
          version: 21

      - name: create LLVM tool symlinks
        run: |
          VER=$(clang --version | head -1 | grep -oP '(?<=version )\d+')
          for versioned in /usr/bin/llvm-*-${VER} \
                           /usr/bin/clang-apply-replacements-${VER} \
                           /usr/bin/clang-check-${VER} \
                           /usr/bin/clang-extdef-mapping-${VER} \
                           /usr/bin/clang-query-${VER} \
                           /usr/bin/clang-rename-${VER} \
                           /usr/bin/clang-tblgen-${VER}; do
            [ -e "$versioned" ] || continue
            base=$(basename "$versioned" "-${VER}")
            # Remove any pre-installed alternative (e.g. llvm-18) before registering
            sudo update-alternatives --remove-all "$base" 2>/dev/null || true
            sudo update-alternatives --install /usr/bin/"$base" "$base" "$versioned" 100
          done

      - name: Run clang-format on all tracked C/C++ files
        run: |
          # Same extension list as cmake/ClangFormat.cmake
          git ls-files -z \
            '*.h' '*.c' '*.hpp' '*.cpp' '*.hxx' '*.cxx' \
            '*.hh' '*.cc' '*.ipp' '*.inc' '*.inl' \
            ':(exclude)cmake/' \
            | xargs -0 clang-format -i

      - name: Commit and push if anything changed
        run: |
          if git diff --quiet; then
            echo "Nothing to format."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -u
          git commit -m "style: auto-apply clang-format [skip ci]"
          git push
