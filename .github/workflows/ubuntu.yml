name: Ubuntu

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14 coinor-libcbc-dev libboost-container-dev libspdlog-dev lcov

      - name: install parquet
        run: |
          sudo apt-get install -y -V ca-certificates lsb-release wget
          wget https://packages.apache.org/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get install -y -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get update
          sudo apt-get install -y -V libarrow-dev libparquet-dev

      - name: setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ github.workflow }}-build

      - name: configure
        run: cmake -Stest -Bbuild -DENABLE_TEST_COVERAGE=1 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        env:
          CC: gcc-14
          CXX: g++-14

      - name: build
        run: cmake --build build -j4

      - name: test
        run: |
          cd build
          ctest --build-config Debug

      - name: collect code coverage
        run: |
          # Capture coverage data with lcov
          # --ignore-errors mismatch,mismatch: fully suppress mismatch warnings
          #   from third-party headers (daw_json, boost, libstdc++)
          # --rc unexecuted_blocks=1: fix warnings about unexecuted blocks
          #   on non-branch lines in system headers (e.g. c++config.h:547)
          # --rc branch_coverage=1: enable branch coverage tracking
          lcov --capture --directory build --output-file coverage-raw.info \
            --gcov-tool gcov-14 --ignore-errors mismatch,mismatch \
            --rc unexecuted_blocks=1 \
            --rc branch_coverage=1
          # Remove external/test/system files from coverage
          lcov --remove coverage-raw.info \
            '/usr/*' \
            '*/cpm_modules/*' \
            '*/test/*' \
            '*/daw/*' \
            '*/strong_type/*' \
            '*/spdlog/*' \
            --output-file coverage.info \
            --gcov-tool gcov-14 --ignore-errors unused \
            --rc branch_coverage=1
          # Print summary to the job log
          lcov --list coverage.info --gcov-tool gcov-14 --rc branch_coverage=1
          # Generate HTML report
          genhtml coverage.info --output-directory coverage-report \
            --title "gtopt C++ Test Coverage" \
            --legend --show-details \
            --rc branch_coverage=1

      - name: upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpp-coverage-report
          path: coverage-report/
          retention-days: 30

      - name: generate coverage summary
        if: always()
        run: |
          if [ ! -f coverage.info ]; then
            echo "## C++ Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Coverage data not available (test or coverage collection step failed)." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          # Extract coverage percentages for the job summary
          SUMMARY=$(lcov --summary coverage.info --gcov-tool gcov-14 --rc branch_coverage=1 2>&1)
          COVERAGE_LINE=$(echo "$SUMMARY" | grep 'lines' | head -1 | sed 's/^ *//')
          COVERAGE_FUNC=$(echo "$SUMMARY" | grep 'functions' | head -1 | sed 's/^ *//')
          COVERAGE_BRANCH=$(echo "$SUMMARY" | grep 'branches' | head -1 | sed 's/^ *//')
          echo "## C++ Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${COVERAGE_LINE} |" >> $GITHUB_STEP_SUMMARY
          echo "| ${COVERAGE_FUNC} |" >> $GITHUB_STEP_SUMMARY
          echo "| ${COVERAGE_BRANCH} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the full HTML coverage report from the **cpp-coverage-report** artifact." >> $GITHUB_STEP_SUMMARY

  integration:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14 coinor-libcbc-dev libboost-container-dev libspdlog-dev

      - name: install parquet
        run: |
          sudo apt-get install -y -V ca-certificates lsb-release wget
          wget https://packages.apache.org/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get install -y -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get update
          sudo apt-get install -y -V libarrow-dev libparquet-dev

      - name: setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ github.workflow }}-integration

      - name: configure
        run: cmake -Sstandalone -Bbuild -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        env:
          CC: gcc-14
          CXX: g++-14

      - name: build
        run: cmake --build build -j4

      - name: integration test
        run: |
          cd build
          ctest --build-config Debug

      - name: install gtopt
        run: cmake --install build --prefix build/install

      - name: verify installed binary has no missing shared libraries
        run: |
          echo "=== ldd output ==="
          ldd build/install/bin/gtopt
          if ldd build/install/bin/gtopt | grep -q "not found"; then
            echo "::error::Installed gtopt binary has missing shared libraries"
            exit 1
          fi
          echo "âœ“ All shared libraries resolved"

      - name: verify installed binary runs
        run: |
          build/install/bin/gtopt --version
          echo "âœ“ Installed gtopt --version works"
