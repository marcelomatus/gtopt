name: Auto-format

# Runs clang-format on every push and auto-commits any fixes back to the
# branch.  This catches code generated by Copilot agents, automated actions,
# and any local commit that bypassed the pre-commit hook.
#
# This is the authoritative formatter: it always uses the pinned clang-format
# version (set in the install-clang action) so all committed code is
# consistently formatted regardless of what version a developer has locally.

on:
  push:
    branches-ignore:
      - master
      - main

# Need write access to push the fixup commit
permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  autoformat:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          # Check out the branch that was pushed (not a detached HEAD)
          ref: ${{ github.head_ref || github.ref_name }}
          # Use a token that is allowed to push to the branch
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install clang-format
        uses: ./.github/actions/install-clang
        with:
          version: 21
          packages: clang-format

      - name: Run clang-format on all tracked C/C++ files
        run: |
          echo "clang-format version: $(clang-format --version)"
          # --diff-filter=d excludes deleted files that git ls-files might list
          git ls-files -z \
            '*.h' '*.c' '*.hpp' '*.cpp' '*.hxx' '*.cxx' \
            '*.hh' '*.cc' '*.ipp' '*.inc' '*.inl' \
            ':(exclude)cmake/' \
            | xargs -0 clang-format -i

      - name: Commit and push if anything changed
        run: |
          if git diff --quiet; then
            echo "Nothing to format."
            echo "## âœ… Auto-format: nothing to fix" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          CHANGED=$(git diff --name-only | wc -l)
          echo "Reformatted $CHANGED file(s):"
          git diff --name-only

          echo "## ðŸ–Šï¸ Auto-format: fixed $CHANGED file(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File |" >> $GITHUB_STEP_SUMMARY
          echo "|------|" >> $GITHUB_STEP_SUMMARY
          git diff --name-only | while read -r f; do
            echo "| \`$f\` |" >> $GITHUB_STEP_SUMMARY
          done

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -u
          git commit -m "style: auto-apply clang-format [skip ci]"
          git push
