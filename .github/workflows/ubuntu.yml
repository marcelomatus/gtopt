name: Ubuntu

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ---- Compiler selection ----
# Change ACTIVE_COMPILER to 'gcc' to switch to the GCC build compiler.
# The CC/CXX/GCOV_TOOL/CLANG_COVERAGE_RUNTIME variables below are set
# automatically; do not change them directly.
env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules
  ACTIVE_COMPILER: clang
  CC: clang
  CXX: clang++
  GCOV_TOOL: /tmp/llvm-gcov.sh
  CLANG_COVERAGE_RUNTIME: 'true'

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    name: build (${{ env.ACTIVE_COMPILER }})

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-${{ env.ACTIVE_COMPILER }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends coinor-libcbc-dev libboost-container-dev libspdlog-dev lcov ca-certificates lsb-release wget
          wget https://packages.apache.org/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get install -y --no-install-recommends -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends -V libarrow-dev libparquet-dev

      - name: install clang
        uses: ./.github/actions/install-clang
        with:
          version: 21
          install-coverage-runtime: ${{ env.CLANG_COVERAGE_RUNTIME }}

      - name: setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ github.workflow }}-${{ env.ACTIVE_COMPILER }}-build
          max-size: 2G

      - name: configure
        run: cmake -Stest -Bbuild -DENABLE_INTEGRATION_TESTS=ON -DENABLE_TEST_COVERAGE=1 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        env:
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}

      - name: build
        run: cmake --build build -j$(nproc)

      - name: verify binary has no missing shared libraries
        run: |
          echo "=== ldd output ==="
          ldd build/gtopt
          if ldd build/gtopt | grep -q "not found"; then
            echo "::error::gtopt binary has missing shared libraries"
            exit 1
          fi
          echo "‚úì All shared libraries resolved"

      - name: verify binary runs
        run: |
          build/gtopt --version
          echo "‚úì gtopt --version works"

      - name: test
        run: |
          set -o pipefail
          cd build
          ctest --build-config Debug --output-on-failure 2>&1 | tee ctest_output.log
          echo ""
          echo "=== Test Summary ==="
          TOTAL=$(grep -c "Test #" ctest_output.log || echo 0)
          PASSED=$(grep -c "Passed" ctest_output.log || echo 0)
          FAILED=$(grep -c "Failed" ctest_output.log || echo 0)
          echo "Total: $TOTAL | Passed: $PASSED | Failed: $FAILED"

      - name: upload gtopt binary
        uses: actions/upload-artifact@v4
        with:
          name: gtopt-binary-debug
          path: build/gtopt
          retention-days: 7

      - name: collect coverage (unit + integration)
        if: always()
        run: |
          # Set up gcov tool: for clang create llvm-cov wrapper, for gcc use gcov-14 directly
          if [ "${{ env.ACTIVE_COMPILER }}" = "clang" ]; then
            printf '#!/bin/sh\nexec llvm-cov gcov "$@"\n' > /tmp/llvm-gcov.sh
            chmod +x /tmp/llvm-gcov.sh
          fi
          GCOV_TOOL="${{ env.GCOV_TOOL }}"
          # Capture coverage data with lcov
          # --ignore-errors mismatch,mismatch: fully suppress mismatch warnings
          #   from third-party headers (daw_json, boost, libstdc++)
          # --ignore-errors unexecuted,unexecuted: fully suppress unexecuted block
          #   warnings from system/third-party headers (allocator, flat_map, etc.)
          # --ignore-errors negative,negative: suppress negative branch count
          #   errors from system headers (unique_ptr, etc.)
          # --rc geninfo_unexecuted_blocks=1: tell geninfo to zero out counts on
          #   unexecuted non-branch lines (eliminates "unexecuted block" warnings)
          # --rc branch_coverage=1: enable branch coverage tracking
          lcov --capture --directory build --output-file coverage-raw.info \
            --gcov-tool ${GCOV_TOOL} \
            --ignore-errors mismatch,mismatch \
            --ignore-errors unexecuted,unexecuted \
            --ignore-errors negative,negative \
            --ignore-errors inconsistent,inconsistent \
            --rc geninfo_unexecuted_blocks=1 \
            --rc branch_coverage=1
          # Remove external/test/system files from coverage
          lcov --remove coverage-raw.info \
            '/usr/*' \
            '*/cpm_modules/*' \
            '*/test/*' \
            '*/daw/*' \
            '*/strong_type/*' \
            '*/spdlog/*' \
            --output-file coverage.info \
            --gcov-tool ${GCOV_TOOL} --ignore-errors unused,inconsistent \
            --rc branch_coverage=1
          # Print summary to the job log
          lcov --list coverage.info --gcov-tool ${GCOV_TOOL} --rc branch_coverage=1 \
            --ignore-errors inconsistent
          # Generate HTML report
          genhtml coverage.info --output-directory coverage-report \
            --title "gtopt C++ Coverage (Unit + Integration)" \
            --legend --show-details \
            --rc branch_coverage=1 \
            --ignore-errors inconsistent

      - name: upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpp-coverage-report-${{ env.ACTIVE_COMPILER }}
          path: coverage-report/
          retention-days: 30

      - name: generate coverage summary
        if: always()
        run: |
          GCOV_TOOL="${{ env.GCOV_TOOL }}"
          if [ ! -f coverage.info ]; then
            echo "## C++ Coverage (Unit + Integration)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Coverage data not available (test or coverage collection step failed)." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          # Extract coverage percentages for the job summary
          SUMMARY=$(lcov --summary coverage.info --gcov-tool ${GCOV_TOOL} --rc branch_coverage=1 \
            --ignore-errors inconsistent,inconsistent 2>&1) || true
          LINE_PCT=$(echo "$SUMMARY" | grep 'lines' | head -1 | grep -oP '[\d.]+%' | head -1)
          LINE_DETAIL=$(echo "$SUMMARY" | grep 'lines' | head -1 | grep -oP '\(.*\)')
          FUNC_PCT=$(echo "$SUMMARY" | grep 'functions' | head -1 | grep -oP '[\d.]+%' | head -1)
          FUNC_DETAIL=$(echo "$SUMMARY" | grep 'functions' | head -1 | grep -oP '\(.*\)')
          BRANCH_PCT=$(echo "$SUMMARY" | grep 'branches' | head -1 | grep -oP '[\d.]+%' | head -1)
          BRANCH_DETAIL=$(echo "$SUMMARY" | grep 'branches' | head -1 | grep -oP '\(.*\)')
          echo "## C++ Coverage (Unit + Integration)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINE_PCT} | ${LINE_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${FUNC_PCT} | ${FUNC_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${BRANCH_PCT} | ${BRANCH_DETAIL} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # List files with 0% line coverage (coverage gaps)
          ZERO_FILES=$(lcov --list coverage.info --gcov-tool ${GCOV_TOOL} --rc branch_coverage=1 2>&1 | grep '|.*0\.0%' | head -10 || true)
          if [ -n "$ZERO_FILES" ]; then
            echo "<details><summary>‚ö†Ô∏è Files with 0% line coverage</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$ZERO_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "üì• Download the full HTML coverage report from the **cpp-coverage-report** artifact." >> $GITHUB_STEP_SUMMARY

